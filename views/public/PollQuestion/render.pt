<tal:block define="model request/model;
                    has_voted model/has_voted;
                    edit_mode python:request.get('edit_mode', False);
                    has_voted python: has_voted or (edit_mode or
                                            (request.get('pollid') == '/'.join(model.getPhysicalPath()) and model.manage_vote(request)));
                    display_question python:edit_mode or model.display_question();
                    display_results python:edit_mode or model.display_results();
                    display_too_late python: model.display_too_late()"
                    xmlns:i18n="http://xml.zope.org/namespaces/i18n"
                    i18n:domain="silva_poll">
  <!-- note that nothing is displayed if the user has not voted and neither the
        question not the results should be displayed -->
  <h2 tal:content="request/model/get_title_or_id" class="heading" />
  <table class="poll">
    <tbody>
      <tr>
        <td class="poll_head">
          <img tal:attributes="src here/service_resources/SilvaPoll/poll_head.gif/absolute_url" 
                class="poll_head" />
        </td>
      </tr>
    </tbody>
  </table>
  <tal:block condition="not: display_too_late">
    <tal:block condition="python: edit_mode or (display_question and 
                                                  not has_voted)">
      <h3 tal:content="model/get_question" class="poll_question" />
      <script type="text/javascript">
        // <![CDATA[

          function checkRadioSelected(form) {
            var inputs = form.getElementsByTagName('input');
            for (var i=0; i < inputs.length; i++) {
              if (inputs[i].type == 'radio' && inputs[i].checked) {
                return true;
              };
            };
            var error_message = document.getElementById('error_nothing_selected');
            error_message.style.display = "block";
            return false;
          };

        // ]]>
      </script>
      <form method="post" action="" tal:define="answers model/get_answers"
            onsubmit="return checkRadioSelected(this)">

        <input type="hidden" name="pollid" 
                tal:attributes="value python:'/'.join(model.getPhysicalPath())" 
                />
        <table class="poll">
          <tal:block repeat="i python:xrange(len(answers))">
            <tr>
              <td tal:attributes="class python: repeat['i'].end and 'poll_last' or 'poll_radio'">
                <input type="radio" name="answer" class="poll"
                        tal:attributes="value python:answers[i];
                                        id string:answer_${i}" />
              </td>
              <td class="poll_label" tal:attributes="class python:repeat['i'].end and 'poll_last' or 'poll_label'">
                <label tal:attributes="for string:answer_${i}" class="p">
                  <tal:block replace="python: answers[i]" />
                </label>
              </td>
            </tr>
          </tal:block>
        </table>
        <span class="error" id="error_nothing_selected" style="display:none;" i18n:translate="">Please select an answer</span>
        <input type="image" 
                tal:attributes="src here/service_resources/SilvaPoll/send.gif/absolute_url" 
                value="submit" 
                class="poll_submit" />
      </form>
    </tal:block>
    <tal:block condition="python: (has_voted or not display_question) and
                                    display_results">
      <tal:block define="answers model/get_answers; 
                          votes model/get_votes;
                          total python: sum(votes) * 1.0;
                          ">
      <h3 tal:content="model/get_question" class="poll_results" />
        <table class="poll">
          <tbody>
            <tr tal:repeat="i python:xrange(len(answers))">
              <td tal:attributes="class python:repeat['i'].end and 'poll_result_label_last' or 'poll_result_label'">
                <p class="p" tal:content="python: answers[i]" /> 
              </td>
              <td tal:attributes="class python:repeat['i'].end and 'poll_result_result_last' or 'poll_result'"
                  tal:define="percentage python: (total and round((votes[i] / total) * 100) or 0)">
                <div class="poll_bar_outer">
                  <div class="poll_bar_inner">
                    <img class="poll_bar"
                          tal:attributes="src here/service_resources/SilvaPoll/poll_bar.gif/absolute_url;
                                          width percentage">
                  </div>
                </div>
                <p class="p">
                <b tal:content="string:${percentage} %" /><br />
                  <tal:block replace="python:votes[i]" />
                  <tal:condition condition="python:int(votes[i]) == 1"
                    i18n:translate="">
                      Vote
                  </tal:condition>
                  <tal:condition condition="python:int(votes[i]) == 0 or int(votes[i]) > 0"
                    i18n:translate="">
                      Votes
                  </tal:condition>
                </p>
              </td>
            </tr>
          </tbody>
        </table>
      </tal:block>
    </tal:block>
    <tal:block condition="python:(not has_voted and not display_question) and not display_results">
      <br />
      <p class="p"
         i18n:translate="">
        This poll is available from
        <tal:block define="sdt model/question_start_datetime"
                    content="python: sdt and '%s.%s.%s' % (sdt.day(), sdt.month(), sdt.year()) or '-'"
                    i18n:name="startdatetime" />.
      </p>
    </tal:block>
    <tal:block condition="python: has_voted and not display_results">
      <h3 class="poll_question"
          i18n:translate="">Many thanks for your partipation!</h3>
      <p i18n:translate=""
         tal:define="sdt model/result_start_datetime;
                      edt model/result_end_datetime;
                      fsdt python: sdt and '%s.%s.%s' % (sdt.day(), sdt.month(), sdt.year()) or '';
                      fedt python: edt and '%s.%s.%s' % (edt.day(), edt.month(), edt.year()) or '';
                      "
          class="p">
        The results will be available on this site
        <span i18n:name="from-until-or-from">
          <span tal:condition="edt"
            i18n:translate="">
              from
              <span tal:content="fsdt" i18n:name="startdate" />
              until <span tal:content="fedt" i18n:name="enddate" />
          </span>
          <span tal:condition="not:edt"
            i18n:translate="">
              from
              <span tal:content="fsdt" i18n:name="startdate"/>
          </span>.
        </span>
      </p>
      <p tal:define="url python:model.get_silva_object().absolute_url()"
          class="p">
        <a tal:attributes="href url"
            tal:content="url">url</a>
        <em id="bookmark_link_placeholder"
              tal:attributes="silva:url url;
                                silva:title model/get_title_or_id;"></em>
        <script type="text/javascript">
          // <![CDATA[
          if (window.external) {
            var ph = document.getElementById('bookmark_link_placeholder');
            var a = document.createElement('a');
            a.href = '#';
            a.onclick = function(evt) {
              window.external.AddFavorite(ph.getAttribute('silva:url'),
                                            ph.getAttribute('silva:title'));
              event.returnValue = false;
              event.cancelBubble = true;
            };
            a.appendChild(document.createTextNode(
                            '[zu Favoriten hinzuf\xfcgen]'));
            ph.appendChild(a);
          };
          // ]]>
        </script>
      </p>
    </tal:block>
  </tal:block>
  <tal:block condition="display_too_late">
    <br />
    <p class="p"
      i18n:translate="">
      Thank you for your interest, unfortunately the results of this poll are
      no longer available."
    </p>
  </tal:block>
</tal:block>
